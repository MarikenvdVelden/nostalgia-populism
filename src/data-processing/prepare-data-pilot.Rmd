---
title: 'Prepare Data Pilot Studies'
author: 
output: 
  github_document:
    toc: yes
always_allow_html: true
editor_options: 
  
  chunk_output_type: console
---

```{r "setup", include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE,
                      fig.align = "center",
                      fig.path=('../../report/figures/'))
library(printr)
options(digits = 2)
library(rmarkdown)
```

## Required Packages &amp; Reproducibility
```{r "env", message=FALSE, warning=F}
rm(list=ls())
source(here::here("src/lib/functions.R"))
#renv::snapshot()
```

## Tidy Data
This code chuck downloads the data from cleans the raw data. We impute missing values based on the following criteria:

- If 10\% or less of the values on the dimension are missing, then we re-code the missing values to the overall mean. 
- If 11\% or more of the values on the dimension are missing, then we re-code the missing values to a constant (for instance 0) and include a dummy variable indicating whether the response on the covariate was missing or not.

We recode the missing values of the conspiracy belief variables, age, gender, and ideology to the mean value of the respective variables.
For the conspiracy belief variables as well as for the ideology variable, we additionally add a dummy variable indicating whether this variable was missing.

```{r "get data for S1", message=FALSE}
d1 <- fetch_survey(surveyID = "SV_6nXTxSvj5FOOZsW", 
                    verbose = TRUE, force_request = T,
                    label = FALSE, convert = FALSE) #anonymous message

d2 <- fetch_survey(surveyID = "SV_8H3HjWDoT94ymRE", 
                    verbose = TRUE, force_request = T,
                    label = FALSE, convert = FALSE) #FvD message

source(here("src/data-processing/pilot.R"))
#For the pilot, replace all missing values with mean/media
source(here("src/data-processing/missing-pilot.R"))
```

```{r "scaling variables"}
source(here("src/data-processing/scales.R"))

kbl(scales, booktabs =T, caption = "Reliability Scales") %>%
  kable_styling(latex_options = c("striped", "hold_position"),
                full_width = F, fixed_thead = T, position = "center") %>%
  column_spec(1, width = "6cm") %>%
  column_spec(2, width = "6cm")  

rm(scales)
```

## Save Data for Analysis
```{r "save data"}
save(d1, file = here("data/intermediate/pilot1.RData"))
save(d2, file = here("data/intermediate/pilot2.RData"))
```

## Visualization of Data

### Dependent Variable
```{r "Dependent Variable Obs", echo=F, fig.width=10, fig.height=8}
tmp <- d2 %>% select(populist, pluralist, elitist, message)
d1 %>%
select(populist, pluralist, elitist, message) %>% 
  add_row(tmp) %>% 
  pivot_longer(cols = populist:elitist,
               names_to = "dvs") %>% 
  mutate(dvs = recode(dvs,
                      populist = "Populist Attitudes",
                      pluralist = "Pluralist Attitudes",
                      elitist = "Elitist Attitudes"),
         message = ifelse(message == "anonymous", "Anonymous Message", 
                          "Party Message")) %>%
  group_by(dvs, message) %>%
  summarise(means = mean(value, na.rm=T),
            stdev = sd(value, na.rm=T)) %>%
  mutate(lower = means - (1.96 * stdev),
         upper = means + (1.96 * stdev)) %>% 
  ggplot(aes(x = dvs, y = means, color = message,
             ymin = lower, ymax = upper)) +
  geom_point(position = position_dodge(.5)) + 
  geom_errorbar(position = position_dodge(.5), width = 0) +
  labs(y = "1 (not at all) - 5 (very strong)", 
       x = "") +
  geom_hline(yintercept = 3, linetype = "dotted", color = "darkgrey") +
  theme_ipsum() +
  coord_flip() +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position="bottom",
        legend.title = element_blank()) 
rm(tmp)
```

### Independent Variables 
```{r "Independent Variables Obs", echo=F, message=FALSE, warning=FALSE,fig.width=10, fig.height=10}
source(here("src/data-processing/ivs_viz_pilot.R"))
((p2 / p3 /p4 )| p1) +
  plot_layout(guides = 'collect') & theme(legend.position = 'bottom')
```




